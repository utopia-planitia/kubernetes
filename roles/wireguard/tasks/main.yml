---

- name: create cache directory
  file:
    path: /var/cache/wireguard-deb
    state: directory

- name: copy packages
  copy:
    src: "{{ item }}"
    dest: "/var/cache/wireguard-deb/{{ item }}"
  with_items:
    - wireguard-dkms_0.0.20190227-wg1~bionic_all.deb
    - wireguard-tools_0.0.20190227-wg1~bionic_amd64.deb
    - wireguard_0.0.20190227-wg1~bionic_all.deb
  notify:
    - install packages

- meta: flush_handlers

- name: set private ip
  set_fact:
    wireguard_private_ip: "10.0.1.{{ groups['all'].index(inventory_hostname) + 1 }}"

- name: create configuration directory
  file:
    path: /etc/wireguard
    state: directory

- name: create configuration
  template:
    src: wg.conf.j2
    dest: /etc/wireguard/wg0.conf
    owner: root
    group: root
    mode: 0600
  notify: restart wg-quick@wg0

- meta: flush_handlers

- name: start wireguard
  systemd:
    name: "wg-quick@wg0"
    enabled: yes
    state: started
